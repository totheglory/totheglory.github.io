<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="keep moving"><title>Java类编译，加载，执行 | terrence mu's blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Java类编译，加载，执行</h1><a id="logo" href="/.">terrence mu's blog</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Java类编译，加载，执行</h1><div class="post-meta">Mar 20, 2017<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><p><strong>Java类编译，加载和执行</strong><br>Java类的编译，加载和执行，常常被人们忽略。现在我们来看看这块具体的相关知识。</p>
<p>1.Java类编译<br>Javac编译类的步骤如下:</p>
<img src="/2017/03/20/javacompile/javacompile.png" alt="java compile process" title="java compile process">
<p>a.调用com.sun.tools.javac.parser.Scanner对java类做词法分析，将代码字符串转变为token序列。<br>b.调用com.sun.tools.javac.parser.Parser对token序列做语法分析，将token序列生成抽象语法树。<br>c.调用com.sun.tools.javac.comp.Enter将符号输入到符号表，通常包括确定类的超类型和接口，类构造器及符号等。<br>d.如果当前类包含用户自定义的注解,则会进行注解处理，生成附加代码或进行特殊检查,并再次进入a-c的步骤来进行词法和语法分析并输入到符号表。<br>e.基于抽象语法树进行语义分析，将语法树中的名字，表达式等元素与变量，方法，类型作关联，检查变量使用前是否已声明，推导泛型参数类型，检查类型匹配，检查变量赋值，检查语句可达性，去掉语法糖等。<br>d.语义分析完成后，调用com.sun.tools.javac.jvm.gen来生成class文件。生成的大致步骤如下：将实例成员初始化器收集到构造器中，将静态成员初始化器收集到<clinit>()中d.语义分析完成后，调用com.sun.tools.javac.jvm.gen来生成class文件。生成的大致步骤如下：将实例成员初始化器收集到构造器中，将静态成员初始化器收集到<clinit>()中。后续遍历抽象语法树，进行少量的代码转换，生成字节码，最后从符号表生成class文件。<br>e.class文件不仅包含了字节码，还包含了JVM用来执行class的附加信息。<br>概括来说：包括class文件格式版本号及各部分的数量与大小信息。<br>元数据-类、继承的超类、实现的接口声明，域与方法声明信息和常量池。<br>方法信息-字节码，异常处理表，求值栈与局部变量区大小，求值栈的类型记录，调式用符号信息。</clinit></clinit></p>
<p>2.Java类加载<br>Java JVM将类加载分为三个阶段:装载，链接和初始化。链接又细分为验证，准备，解析三个阶段。其中装载，验证，准备和初始化发生的顺序是确定的，但之间却没有严格的顺序完成的要求，通常都是各个阶段间交替混合进行的。而解析阶段没有这种顺序的要求，可能再初始化之后，也可能在其之前。</p>
<p>.class文件装载和链接过程完成后，即将二进制的字节码转换为Class对象，初始化过程不是加载类时必须触发的，但最迟必须在第一次主动使用对象前执行(给静态变量赋值，调用<clinit>()等)。而一个类的声明周期除了上面三个阶段外，还包括使用，卸载两步。如下所示：</clinit></p>
<img src="/2017/03/20/javacompile/javaload.png" alt="class lifecycle" title="class lifecycle">
<p>a.装载load(查找并加载类的二机制数据)<br>装载主要涉及的类为java.lang.ClassLoader，装载Class的二进制字节码并加载到JVM中，通过类的全限定名及类加载器完成类加载。具体的加载过程如下：<br>(1)通过类的全限定名来获取该类的二进制字节流，来源可能是一个本地class文件，网络下载的class文件，动态生成的class文件，jar或者zip中的class文件，或是专有数据库中提取的class文件等。<br>(2)将该字节流所代表的静态存储结构存储到方法区，转换为方法区的数据结构。<br>(3)在堆内存中生成一个当前类的java.lang.Class对象，作为方法区数据结构的访问入口。<br>JVM比较两个类是否相同，不仅比较类的全名，还比较加载此类的类加载器。只有两者都相同的时候，认为两个是相同的类。这也是代理模式的设计动机，即为了保证Java核心库的类型安全。所有Java应用都至少需要引用java.lang.Object类，通过代理模式，对于Java核心库的类的加载工作由引导类加载器来统一完成，保证了Java应用所使用的都是同一个版本的Java核心库的类，是互相兼容的。<br>真正完成类的加载工作是通过调用defineClass来实现的,如果调用失败会报java.lang.NoClassDefFoundError；而类启动的加载过程是通过调用loadClass来实现的，如果失败会报java.lang.ClassNotFoundException。</p>
<p>b.链接(确保被加载的类的正确性)<br>链接主要是对二进制class文件进行格式校验，初始化装载类中的静态变量及当前类中引用的接口和其他类。<br>链接可以分为三个阶段验证，准备，解析。<br>验证阶段，如果class文件格式验证有问题，会抛出java.lang.VerifyError的错误。校验过程如果需要加载其他的引用接口和类，也会进行加载，如果找不到，则会报java.lang.NoClassDefFoundError。<br>验证分为四个方面的检查:<br>(1)文件格式验证:验证字节流是否符合class文件格式的要求，如是否以OXCAFEBABE开头,版本号是否支持等。<br>(2)原数据验证:对字节码描述的信息进行语义分析，以保证其描述的信息符合Java语言规范的要求，如这个类是否有父类。<br>(3)字节码验证:通过数据流和控制流分析，确定程序语义是合法的。<br>(4)符号引用验证:确保解析动作能正确执行。</p>
<p>准备阶段，为类的静态变量分配内存,并将其初始化为默认值,是正式为类变量分配内存并设置类变量初始值的阶段，这些内存都将在方法区中分配。对于该阶段有以下几点需要注意：<br>1、这时候进行内存分配的仅包括类变量（static），而不包括实例变量，实例变量会在对象实例化时随着对象一块分配在Java堆中。<br>2、这里所设置的初始值通常情况下是数据类型默认的零值（如0、0L、null、false等），而不是被在Java代码中被显式地赋予的值。<br>假设一个类变量的定义为：public static int value = 100；<br>那么变量value在准备阶段过后的初始值为0，而不是100，因为这时候尚未开始执行任何Java方法，而把value赋值为100的putstatic指令是在程序编译后，存放于类构造器<clinit>（）方法之中的，所以把value赋值为100的动作将在初始化阶段才会执行。<br>· 这里还需要注意如下几点：<br>· 对基本数据类型来说，对于类变量（static）和全局变量，如果不显式地对其赋值而直接使用，则系统会为其赋予默认的零值，而对于局部变量来说，在使用前必须显式地为其赋值，否则编译时不通过。<br>· 对于同时被static和final修饰的常量，必须在声明的时候就为其显式地赋值，否则编译时不通过；而只被final修饰的常量则既可以在声明时显式地为其赋值，也可以在类初始化时显式地为其赋值，总之，在使用前必须为其显式地赋值，系统不会为其赋予默认零值。<br>· 对于引用数据类型reference来说，如数组引用、对象引用等，如果没有对其进行显式地赋值而直接使用，系统都会为其赋予默认的零值，即null。<br>· 如果在数组初始化时没有对数组中的各元素赋值，那么其中的元素将根据对应的数据类型而被赋予默认的零值。</clinit></p>
<p>3、如果类字段的字段同时被final和static修饰，那么在准备阶段变量value就会被初始化为所指定的值。<br>假设上面的类变量value被定义为： public static final int value = 200；<br>在准备阶段虚拟机就会将value赋值为200.</p>
<p>解析阶段，是虚拟机将常量池内的符号引用替换为直接引用的过程。对类或接口、字段、类方法、接口方法、方法类型、方法句柄和调用点限定符7类符号引用进行解析。如果这个阶段失败，会产生NoSuchMethodError，NoSuchFieldError等错误。<br>JVM实现的解析策略可能互不同。一种是在链接的时候，就把所有依赖的引用都解析出来。而另外一种则是只有在这个引用真正要用到的时候,才进行解析。</p>
<p>c.初始化<br>初始化过程主要操作的静态初始化代码，构造器代码以及静态属性的初始化。<br>初始化执行前，必须完成链接的校验和准备阶段，解析没有特别要求。<br>触发java接口和类初始化的情况有以下几种：<br>1.创建实例<br>2.子类初始化<br>3.JVM启动过程中指定的初始化类<br>4.反射调用了类中的方法<br>5.调用类的静态方法<br>6.访问某个类或者接口的静态变量，或者对该静态变量赋值</p>
<p>d.JVM结束生命周期<br>1.执行了system.exit()方法<br>2.程序正常执行结束<br>3.程序执行过程中遇到了异常或错误而异常中止<br>4.操作系统错误导致的JVM进程挂掉</p>
<p>3.Java类执行</p>
<p>a.解释执行<br>解释执行主要是JVM基于字节码进行的。具体的JVM采用了invokestatic，invokevirtual，invokeinterface和invokespecial来执行不同的方法调用。<br>invokestatic对应的是static方法的调用。<br>invokevirtual对应的是对象实例方法的调用。<br>invokeinterface对应的是接口方法的调用。<br>invokespecial对应的是private方法和<init>方法的调用。<br>b.编译执行<br>JDK提供将字节码编译为机器码的支持，编译在执行时执行频率较高的代码。<br>JDK在编译上提供了两种模式:clent compiler(-client)和server compiler(-server)<br>JDK主要是根据栈的结构来执行字节码的，具体如下图：</init></p>
<img src="/2017/03/20/javacompile/zhanzhen.png" alt="class lifecycle" title="class lifecycle">
<p>SUN JDK对Java类执行的一些优化：<br>1.操作数栈顶的数据直接缓存在寄存器中，对于大部分只需要一个值的操作，无需再将数据放入操作数栈，可直接在寄存器计算。<br>2.栈帧共享，后面调用的方法将前一个方法的操作数栈作为当前方法的局部变量。减少数据copy的性能消耗。<br>3.编译执行(JIT编译器)对执行频繁的代码采用编译执行，他包含两种模式:client compiler(-client)即c1和server compiler(-server)即c2。</p>
<p>c1的优化<br>client compiler(c1)主要用于桌面交互的应用，在寄存器分配策略上，JDK6以后采用的为线性扫描寄存器分配算法。还有就是方法内联，去虚拟化，冗余削除等。<br>-XX:+PrintInlining来查看方法内联的信息。<br>去虚拟化是在装载class文件后，进行类层次的分析，如果类中的方法只提供一个实现类，那么对于调用了此方法的代码，也可进行方法内联，从而提升执行的性能。<br>冗余削除是指在编译时，根据运行状况进行代码折叠或削除。</p>
<p>c2的优化<br>c2在寄存器分配策略上，采用传统的图着色寄存器分配算法。C2的优化主要机遇逃逸分析。逃逸分析指的是JVM根据运行状况来判断当前方法中的变量是否被外部引用，如果外部不引用，则认为是逃逸的。基于逃逸分析，主要的优化点有：<br>标量替换，栈上分配和同步削除等。</p>
<p>默认情况在，JDK根据机器配置来选择client或server模式，32位windows机器始终选择的是client模式，当机器配置超过2核且内存&gt;2G默认为server模式。可以通过启动参数-client或-server强制指定。</p>
<p>JDK未选择启动时即编译成机器码的原因<br>1.静态编译后无法根据运行情况做优化。<br>2.解释执行比编译执行更节省内存。<br>3.启动时的解释执行速度比编译后再启动更快。</p>
<p>JDK用于权衡编译和解释代码的转换，主要基于两个维度的统计值。</p>
<p>1.调用计数器,即方法被调用的次数。<br>CompileThreshold<br>该值是指当方法被调用多少次后，就会被编译为机器码。在client模式下默认为1500次，在server模式下默认为10 000次，可通过在启动时添加-XX:CompileThreshold=10000来设置该值。</p>
<p>2.回边计数器,即循环体内代码被执行的次数。<br>OnStackReplacePercentage<br>该值为用于计算是否触发OSR编译的阈值，默认情况下client模式时为933，server模式下为140，该值可通过在启动时添加-XX: OnStackReplacePercentage=140来设置，在client模式时，计算规则为CompileThreshold <em> (OnStackReplacePercentage/100)，在server模式时，计算规则为(CompileThreshold </em> (OnStackReplacePercentage - InterpreterProfilePercentage))/100。InterpreterProfilePercentage默认值为33。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2017/03/20/javacompile/" data-id="cj9cevwpi0004fu1hxzvjlia5" class="article-share-link">Share</a><div class="tags"><a href="/tags/Java原理/">Java原理</a></div><div class="post-nav"><a href="/2017/04/10/javaclass/" class="pre">Java Class文件</a><a href="/2017/02/10/file/" class="next">JAVA IO -- File</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/JMM/" style="font-size: 15px;">JMM</a> <a href="/tags/JAVA-IO-JDK-File/" style="font-size: 15px;">JAVA IO, JDK , File</a> <a href="/tags/JDK-Class文件/" style="font-size: 15px;">JDK,Class文件</a> <a href="/tags/Java原理/" style="font-size: 15px;">Java原理</a> <a href="/tags/MySQL-数据库设计/" style="font-size: 15px;">MySQL,数据库设计</a> <a href="/tags/分布式锁-GFS-Big-Table/" style="font-size: 15px;">分布式锁,GFS,Big Table</a> <a href="/tags/regex，DFA，NFA/" style="font-size: 15px;">regex，DFA，NFA</a> <a href="/tags/chubby-paxos/" style="font-size: 15px;">chubby paxos</a> <a href="/tags/paxos-分布式/" style="font-size: 15px;">paxos,分布式</a> <a href="/tags/zab-ZooKeeper/" style="font-size: 15px;">zab, ZooKeeper</a> <a href="/tags/分布式一致性-zookeeper-ZAB/" style="font-size: 15px;">分布式一致性,zookeeper,ZAB</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/10/28/mysqlstudy/">高性能MySQL 学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/23/regextips/">正则表达式Tips</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/13/jmm/">Java Memory Model</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/11/javaio/">javaio</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/10/javaclass/">Java Class文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/20/javacompile/">Java类编译，加载，执行</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/10/file/">JAVA IO -- File</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/29/zab/">zab 协议</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/25/zookeeper/">zookeeper简介</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/12/paxosinchubby/">paxos在chubby的应用</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">terrence mu's blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>